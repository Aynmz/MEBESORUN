using System;
using System.Net.Http;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace MEBESORUN
{
    public class LocalLlmClient : IDisposable
    {
        private readonly HttpClient _httpClient;
        private readonly string _apiKey;
        private readonly string _baseUrl;
        private readonly string _model;
        private bool _disposed;

        public LocalLlmClient()
        {
            // Güvenlik: Anahtar asla kaynak kodda saklanmamalı.
            // Beklenen kullanım: OPENAI_API_KEY ortam değişkeni veya bir secret manager.
            _apiKey = Environment.GetEnvironmentVariable("OPENAI_API_KEY")?.Trim() ?? "";

            if (string.IsNullOrEmpty(_apiKey))
            {
                // Kullanıcıyı bilgilendir; üretim ortamında exception fırlatılabilir.
                throw new InvalidOperationException("OPENAI_API_KEY ortam değişkeni bulunamadı. Lütfen API anahtarını ortam değişkeni olarak ayarlayın.");
            }

            // Base URL ve model de ortam değişkenleriyle yapılandırılabilir.
            _baseUrl = Environment.GetEnvironmentVariable("OPENAI_BASE_URL")?.Trim() ?? "https://api.openai.com/v1/chat/completions";
            _model = Environment.GetEnvironmentVariable("OPENAI_MODEL")?.Trim() ?? "gpt-3.5-turbo";

            _httpClient = new HttpClient
            {
                Timeout = TimeSpan.FromSeconds(60)
            };
            _httpClient.DefaultRequestHeaders.Clear();
            _httpClient.DefaultRequestHeaders.Add("Authorization", $"Bearer {_apiKey}");
            _httpClient.DefaultRequestHeaders.Add("User-Agent", "MEBESORUN/1.0");
        }

        // CancellationToken ekledim; çağıran fonksiyon isterse iptal edebilir.
        public async Task<string> GenerateAnswerAsync(string prompt, int maxTokens = 400, CancellationToken cancellationToken = default)
        {
            if (string.IsNullOrWhiteSpace(prompt)) return "[HATA] Prompt boş olamaz.";

            var requestBody = new
            {
                model = _model,
                messages = new[]
                {
                    new {
                        role = "system",
                        content = "Sen yasalara ve mevzuata hakim bir uzmansın. Cevabında kaynak dosya adını ve sayfa numarasını belirt. Sadece verilen kaynaklardaki bilgilere dayanarak cevap ver."
                    },
                    new {
                        role = "user",
                        content = prompt
                    }
                },
                max_tokens = maxTokens,
                temperature = 0.1
            };

            var jsonContent = JsonConvert.SerializeObject(requestBody);
            using var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");

            try
            {
                using var response = await _httpClient.PostAsync(_baseUrl, content, cancellationToken).ConfigureAwait(false);

                var responseString = await response.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false);

                if (!response.IsSuccessStatusCode)
                {
                    // API hatasını ham olarak döndür, gerekli yerlerde loglanmalı
                    return $"[API HATA KODU] {(int)response.StatusCode} {response.ReasonPhrase}. Detay: {responseString}";
                }

                // Güvenli parse
                var j = JObject.Parse(responseString);
                var answer = j["choices"]?.First?["message"]?["content"]?.ToString();

                if (string.IsNullOrWhiteSpace(answer))
                {
                    return "[API HATASI] Modelden geçerli bir cevap alınamadı.";
                }

                return answer.Trim();
            }
            catch (TaskCanceledException tce) when (!cancellationToken.IsCancellationRequested)
            {
                return $"[ZAMAN AŞIMI] İstek zaman aşımına uğradı: {tce.Message}";
            }
            catch (OperationCanceledException)
            {
                return "[İPTAL] İstek iptal edildi.";
            }
            catch (Exception ex)
            {
                // Daha ayrıntılı logging için buraya log ekle
                return $"[BAĞLANTI HATASI] {ex.Message}. İnternet bağlantınızı veya API yapılandırmanızı kontrol edin.";
            }
        }

        public void Dispose()
        {
            if (_disposed) return;
            _httpClient?.Dispose();
            _disposed = true;
        }
    }
}
